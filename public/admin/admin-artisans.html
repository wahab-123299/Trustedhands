<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin â€“ Manage Artisans | Trusted Hand</title>
    <link rel="stylesheet" href="../css/admin.css"/>

    <style>
      .search-bar{padding:.6rem;border-radius:6px;border:1px solid #ccc;width:300px}
      table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden}
      th,td{padding:.9rem;border-bottom:1px solid #eee}
      th{background:#007bff;color:#fff}
      tr:hover{background:#f1f1f1}
      .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999}
      .modal-content{background:#fff;padding:2rem;border-radius:8px;width:400px;margin:10% auto;position:relative}
      .close{position:absolute;top:10px;right:15px;font-size:1.5rem;cursor:pointer}
      .btn-save{margin-top:1rem;width:100%;padding:.7rem;background:#007bff;color:#fff;border:none;border-radius:6px}
      .approve{background:#198754;color:#fff;border:none;padding:.4rem .8rem;border-radius:4px}
      .suspend{background:#dc3545;color:#fff;border:none;padding:.4rem .8rem;border-radius:4px}
    </style>
  </head>
  <body>

    <div class="admin-container">

      <!-- SIDEBAR -->
      <aside class="sidebar">
        <h2>Trusted Hand</h2>
        <ul>
          <li><a href="admin-dashboard.html">Dashboard</a></li>
          <li><a href="admin-users.html">Users</a></li>
          <li><a class="active">Artisans</a></li>
          <li><a href="admin-jobs.html">Jobs</a></li>
          <li><a href="admin-payments.html">Payments</a></li>
          <li><a href="#" onclick="logout()">Logout</a></li>
        </ul>
      </aside>

      <!-- MAIN -->
      <main class="main-content">
        <header>
          <h1>Manage Artisans</h1>
          <input id="search" class="search-bar" placeholder="Search name, profession, location"/>
        </header>

        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Profession</th>
              <th>Location</th>
              <th>Rating</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="artisanList">
            <tr><td colspan="7">Loading...</td></tr>
          </tbody>
        </table>
      </main>
    </div>

    <!-- MODAL -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Edit Artisan</h3>

        <form id="editForm">
          <input type="hidden" id="artisanId"/>
          <label>Name</label>
          <input id="name" required/>
          <label>Profession</label>
          <input id="profession" required/>
          <label>Location</label>
          <input id="address" required/>
          <label>Status</label>
          <select id="status">
            <option>Active</option>
            <option>Pending</option>
            <option>Suspended</option>
          </select>
          <button class="btn-save">Save</button>
        </form>
      </div>
    </div>

    <script>
      const token = localStorage.getItem("token");
      if (!token) location.href = "login.html";

      const API = "https://trustedhands-backend.onrender.com/api/admin/artisans";
      const list = document.getElementById("artisanList");
      const modal = document.getElementById("modal");
      let artisans = [];
      let currentId = null;

      /* LOAD */
      async function loadArtisans() {
        const res = await fetch(API, { headers:{Authorization:`Bearer ${token}`}});
        const data = await res.json();
        if (!res.ok) return alert(data.message);
        artisans = data;
        render();
      }

      /* RENDER */
      function render(q="") {
        list.innerHTML = "";
        const f = artisans.filter(a =>
          a.name?.toLowerCase().includes(q) ||
          a.profession?.toLowerCase().includes(q) ||
          a.address?.toLowerCase().includes(q)
        );

        if (!f.length) {
          list.innerHTML = "<tr><td colspan='7'>No artisans</td></tr>";
          return;
        }

        f.forEach(a=>{
          list.innerHTML += `
          <tr>
            <td>${a._id}</td>
            <td>${a.name}</td>
            <td>${a.profession}</td>
            <td>${a.address}</td>
            <td>${a.rating || "N/A"}</td>
            <td>${a.status}</td>
            <td>
              <button class="approve" onclick="edit('${a._id}')">Edit</button>
              ${
                a.status==="Active"
                ? `<button class="suspend" onclick="setStatus('${a._id}','Suspended')">Suspend</button>`
                : `<button class="approve" onclick="setStatus('${a._id}','Active')">Activate</button>`
              }
            </td>
          </tr>`;
        });
      }

      /* EDIT */
      function edit(id){
        const a = artisans.find(x=>x._id===id);
        currentId = id;
        artisanId.value = id;
        name.value = a.name;
        profession.value = a.profession;
        address.value = a.address;
        status.value = a.status;
        modal.style.display="block";
      }

      /* SAVE */
      editForm.onsubmit = async e =>{
        e.preventDefault();
        const res = await fetch(`${API}/${currentId}`,{
          method:"PUT",
          headers:{
            "Content-Type":"application/json",
            Authorization:`Bearer ${token}`
          },
          body:JSON.stringify({
            name:name.value,
            profession:profession.value,
            address:address.value,
            status:status.value
          })
        });
        const d = await res.json();
        if(!res.ok) return alert(d.message);
        modal.style.display="none";
        loadArtisans();
      };

      /* STATUS */
      async function setStatus(id,status){
        const res = await fetch(`${API}/${id}/status`,{
          method:"PUT",
          headers:{
            "Content-Type":"application/json",
            Authorization:`Bearer ${token}`
          },
          body:JSON.stringify({status})
        });
        const d = await res.json();
        if(!res.ok) return alert(d.message);
        loadArtisans();
      }

      /* SEARCH */
      search.onkeyup = e=>render(e.target.value.toLowerCase());

      /* CLOSE */
      document.querySelector(".close").onclick=()=>modal.style.display="none";
      window.onclick=e=>e.target===modal&&(modal.style.display="none");

      /* LOGOUT */
      function logout(){
        localStorage.removeItem("token");
        location.href="login.html";
      }

      loadArtisans();
    </script>

  </body>
</html>