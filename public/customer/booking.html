<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book Artisan | Trusted Hand</title>
  <link rel="stylesheet" href="./css/style.css" />
</head>
<body>

<script>
  // üîê AUTH CHECK (CUSTOMER ONLY)
  const userInfo = JSON.parse(localStorage.getItem("userInfo"));

  if (!userInfo || !userInfo.token || userInfo.role !== "customer") {
    window.location.href = "../auth/login.html";
  }

  const token = userInfo.token;
</script>

<header>
  <div class="container">
    <h1>Trusted Hand</h1>
    <nav>
      <a href="../index.html">Home</a>
      <a href="search.html">Find Artisans</a>
      <a href="my-bookings.html">My Bookings</a>
      <a href="#" id="logoutBtn">Logout</a>
    </nav>
  </div>
</header>

<main class="container">
  <h2>Book Artisan</h2>

  <form id="bookingForm">
    <input type="hidden" id="artisanId" />

    <label>Artisan</label>
    <input type="text" id="artisanName" disabled />

    <label>Job Details</label>
    <textarea id="details" required placeholder="Describe the job..."></textarea>

    <label>Location</label>
    <input type="text" id="location" required />

    <label>Date & Time</label>
    <input type="datetime-local" id="bookingDate" required />

    <button type="submit">Confirm Booking</button>
  </form>

  <p id="statusMessage"></p>
</main>

<footer>
  <p>&copy; 2025 Trusted Hand</p>
</footer>

<script>
  const params = new URLSearchParams(window.location.search);
  const artisanId = params.get("artisanId");
  const artisanName = params.get("artisanName");

  if (!artisanId) {
    alert("Invalid artisan selection");
    window.location.href = "search.html";
  }

  document.getElementById("artisanId").value = artisanId;
  document.getElementById("artisanName").value =
    artisanName || "Selected Artisan";

  const statusMessage = document.getElementById("statusMessage");
  const paymentSection = document.getElementById("paymentSection");

  let createdBookingId = null; // üîê REAL booking ID from backend

  // üì§ CREATE BOOKING
  document.getElementById("bookingForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const bookingData = {
      artisan: artisanId,
      location: document.getElementById("location").value,
      bookingDate: document.getElementById("bookingDate").value,
      details: document.getElementById("details").value,
    };

    try {
      const res = await fetch("https://trustedhands-backend.onrender.com/api/bookings", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(bookingData),
      });

      const data = await res.json();

      if (!res.ok) {
        statusMessage.style.color = "red";
        statusMessage.textContent = data.message || "Booking failed";
        return;
      }

      // ‚úÖ BOOKING CREATED
      createdBookingId = data._id;

      statusMessage.style.color = "green";
      statusMessage.textContent = "Booking created successfully. Proceed to payment.";

      paymentSection.style.display = "block"; // show Pay button

    } catch (err) {
      statusMessage.style.color = "red";
      statusMessage.textContent = "Server error. Try again.";
    }
  });

  // üí≥ PAYSTACK PAYMENT (REAL)
  document.getElementById("payBtn").onclick = async () => {
    try {
      const res = await fetch("https://trustedhands-backend.onrender.com/api/payments/initialize", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({
          bookingId: createdBookingId, // ‚úÖ REAL booking ID
        }),
      });

      const data = await res.json();

      if (!res.ok) {
        alert(data.message || "Payment initialization failed");
        return;
      }

      // üîÅ Redirect to Paystack
      window.location.href = data.authorization_url;
    } catch (err) {
      alert("Payment failed");
    }
  };

  // üö™ LOGOUT
  document.getElementById("logoutBtn").onclick = () => {
    localStorage.clear();
    window.location.href = "../auth/login.html";
  };
</script>

</body>
</html>
