<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Artisan Profile | Trusted Hand</title>
  <link rel="stylesheet" href="../css/style.css" />
</head>
<body>

<header>
  <div class="container">
    <h1>Trusted Hand</h1>
    <nav>
      <a href="../index.html">Home</a>
      <a href="../service.html">Services</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="#" id="logoutBtn">Logout</a>
    </nav>
  </div>
</header>

<main class="container artisan-profile">

  <!-- ARTISAN INFO -->
  <section class="artisan-details">
    <h2 id="artisanName">Loading...</h2>
    <p><strong>Skill:</strong> <span id="artisanSkill"></span></p>
    <p><strong>Experience:</strong> <span id="artisanExp"></span></p>
    <p><strong>Rating:</strong> <span id="artisanRating"></span></p>

    <button class="btn-primary" id="bookBtn" style="display:none;">
      Book Now
    </button>
  </section>

  <!-- REVIEWS -->
  <section class="reviews">
    <h3>Customer Reviews</h3>
    <div id="reviewsContainer"></div>

    <!-- REVIEW FORM -->
    <form class="review-form" id="reviewForm" style="display:none;">
      <h4>Leave a Review</h4>

      <label>Rating</label>
      <select id="rating" required>
        <option value="5">⭐⭐⭐⭐⭐</option>
        <option value="4">⭐⭐⭐⭐</option>
        <option value="3">⭐⭐⭐</option>
        <option value="2">⭐⭐</option>
        <option value="1">⭐</option>
      </select>

      <label>Comment</label>
      <textarea id="comment" required></textarea>

      <button type="submit" class="btn-primary">Submit Review</button>
    </form>
  </section>

</main>

<footer>
  <p>&copy; 2025 Trusted Hand</p>
</footer>

<script>
  const params = new URLSearchParams(window.location.search);
  const artisanId = params.get("id");
  const userInfo = JSON.parse(localStorage.getItem("userInfo"));

  if (!artisanId) {
    document.querySelector("main").innerHTML = "<p>Invalid artisan.</p>";
  }

  // AUTH UI CONTROL
  if (userInfo && userInfo.role === "customer") {
    document.getElementById("bookBtn").style.display = "inline-block";
    document.getElementById("reviewForm").style.display = "block";
  }

  // LOGOUT
  document.getElementById("logoutBtn").onclick = () => {
    localStorage.clear();
    window.location.href = "../auth/login.html";
  };

  async function loadArtisan() {
    const res = await fetch(`https://trustedhands-backend.onrender.com/api/artisans/${artisanId}`);
    const artisan = await res.json();

    document.getElementById("artisanName").textContent = artisan.name;
    document.getElementById("artisanSkill").textContent = artisan.profession;
    document.getElementById("artisanExp").textContent = `${artisan.experience} years`;

    const rating = Math.min(5, Math.max(0, artisan.rating || 0));
    document.getElementById("artisanRating").textContent =
      "⭐".repeat(Math.round(rating)) + ` (${rating.toFixed(1)})`;
  }

  async function loadReviews() {
    const res = await fetch(`https://trustedhands-backend.onrender.com/api/artisans/${artisanId}/reviews`);
    const reviews = await res.json();

    const container = document.getElementById("reviewsContainer");
    container.innerHTML = reviews.length
      ? reviews.map(r => `
          <div class="review">
            <strong>${r.customerName}</strong>
            <span>${"⭐".repeat(r.rating)}</span>
            <p>${r.comment}</p>
          </div>
        `).join("")
      : "<p>No reviews yet.</p>";
  }

  document.getElementById("bookBtn").onclick = () => {
    window.location.href = `booking.html?artisanId=${artisanId}`;
  };

  document.getElementById("reviewForm").onsubmit = async (e) => {
    e.preventDefault();

    const rating = document.getElementById("rating").value;
    const comment = document.getElementById("comment").value;

    const res = await fetch(
      `https://trustedhands-backend.onrender.com/api/artisans/${artisanId}/reviews`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${userInfo.token}`
        },
        body: JSON.stringify({ rating, comment })
      }
    );

    if (res.ok) {
      e.target.reset();
      loadReviews();
      alert("Review submitted");
    }
  };

  loadArtisan();
  loadReviews();
</script>

</body>
</html>
