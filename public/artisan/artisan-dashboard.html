<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Artisan Dashboard - Trusted Hand</title>
  <link rel="stylesheet" href="../css/dashboard.css">
  </head>
  <body>

  <!-- ===== SIDEBAR ===== -->
    <aside class="sidebar">
  <h2>Trusted Hand</h2>
  <ul>
    <li><a href="#current-jobs">Active Jobs</a></li>
    <li><a href="#job-history">Job History</a></li>
    <li><a href="#profile-update">Profile</a></li>
    <li><a href="#" onclick="logout()">Logout</a></li>
  </ul>
    </aside>

    <!-- ===== MAIN ===== -->
    <main class="main-content">

  <header>
    <h2>Welcome, <span id="artisanName">Loading...</span></h2>
    <p>Profession: <span id="artisanProfession">Loading...</span></p>
  </header>

  <!-- ===== ACTIVE JOBS ===== -->
  <section id="current-jobs">
    <h3>Active Jobs</h3>
    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Location</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="jobsTable">
        <tr><td colspan="4">Loading...</td></tr>
      </tbody>
    </table>
  </section>

  <!-- ===== JOB HISTORY ===== -->
  <section id="job-history">
    <h3>Job History & Earnings</h3>

    <div class="earnings-summary">
      <div class="card">
        <h4>Total Jobs</h4>
        <p id="totalJobs">0</p>
      </div>
      <div class="card">
        <h4>Total Earnings</h4>
        <p id="totalEarnings">₦0</p>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Location</th>
          <th>Date</th>
          <th>Earnings</th>
        </tr>
      </thead>
      <tbody id="historyTable">
        <tr><td colspan="4">Loading...</td></tr>
      </tbody>
    </table>
  </section>

  <!-- ===== PROFILE UPDATE ===== -->
  <section id="profile-update">
    <h3>Update Profile</h3>

    <form id="profileForm">
      <label>Full Name</label>
      <input type="text" id="name" required>

      <label>Profession</label>
      <input type="text" id="profession" required>

      <label>Phone</label>
      <input type="text" id="phone" required>

      <label>Location</label>
      <input type="text" id="location" required>

      <button type="submit">Save Changes</button>
    </form>
  </section>

    </main> 

    <script>
/* ======================
   AUTH CHECK
====================== */
const token = localStorage.getItem("token");
if (!token) {
  window.location.href = "../login.html";
}

const API = "https://trustedhands-backend.onrender.com/api/artisans";

/* ======================
   LOAD PROFILE
====================== */
async function loadProfile() {
  try {
    const res = await fetch(`${API}/profile`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message);

    artisanName.textContent = data.name;
    artisanProfession.textContent = data.profession || "-";

    name.value = data.name;
    profession.value = data.profession || "";
    phone.value = data.phone || "";
    location.value = data.address || "";

  } catch (err) {
    alert("Session expired. Please login again.");
    logout();
  }
}

/* ======================
   ACTIVE JOBS
====================== */
async function loadJobs() {
  const table = document.getElementById("jobsTable");
  table.innerHTML = `<tr><td colspan="4">Loading...</td></tr>`;

  try {
    const res = await fetch(`${API}/jobs/active`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    const jobs = await res.json();
    table.innerHTML = "";

    if (!jobs.length) {
      table.innerHTML = `<tr><td colspan="4">No active jobs</td></tr>`;
      return;
    }

    jobs.forEach(job => {
      table.innerHTML += `
        <tr>
          <td>${job.title}</td>
          <td>${job.location}</td>
          <td>${job.status}</td>
          <td>
            <button onclick="completeJob('${job._id}')">
              Mark Complete
            </button>
          </td>
        </tr>`;
    });

  } catch {
    table.innerHTML = `<tr><td colspan="4">Error loading jobs</td></tr>`;
  }
}

/* ======================
   JOB HISTORY
====================== */
async function loadHistory() {
  const table = document.getElementById("historyTable");
  table.innerHTML = `<tr><td colspan="4">Loading...</td></tr>`;

  try {
    const res = await fetch(`${API}/jobs/history`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    const history = await res.json();
    table.innerHTML = "";

    let total = 0;

    if (!history.length) {
      table.innerHTML = `<tr><td colspan="4">No completed jobs</td></tr>`;
    }

    history.forEach(job => {
      total += job.earnings || 0;
      table.innerHTML += `
        <tr>
          <td>${job.title}</td>
          <td>${job.location}</td>
          <td>${new Date(job.completedAt).toLocaleDateString()}</td>
          <td>₦${(job.earnings || 0).toLocaleString()}</td>
        </tr>`;
    });

    totalJobs.textContent = history.length;
    totalEarnings.textContent = "₦" + total.toLocaleString();

  } catch {
    table.innerHTML = `<tr><td colspan="4">Error loading history</td></tr>`;
  }
}

/* ======================
   COMPLETE JOB
====================== */
async function completeJob(id) {
  try {
    const res = await fetch(`${API}/jobs/${id}/complete`, {
      method: "PUT",
      headers: { Authorization: `Bearer ${token}` }
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message);

    alert("Job completed");
    loadJobs();
    loadHistory();

  } catch (err) {
    alert(err.message);
  }
}

/* ======================
   UPDATE PROFILE
====================== */
profileForm.addEventListener("submit", async e => {
  e.preventDefault();

  try {
    const res = await fetch(`${API}/profile`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({
        name: name.value,
        profession: profession.value,
        phone: phone.value,
        address: location.value
      })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message);

    artisanName.textContent = name.value;
    artisanProfession.textContent = profession.value;

    alert("Profile updated");

  } catch (err) {
    alert(err.message);
  }
});

/* ======================
   LOGOUT
====================== */
function logout() {
  localStorage.removeItem("token");
  window.location.href = "../login.html";
}

/* ======================
   INIT
====================== */
window.onload = () => {
  loadProfile();
  loadJobs();
  loadHistory();
};
    </script>

  </body>
</html>
